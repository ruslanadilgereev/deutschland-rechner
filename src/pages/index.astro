---
import Layout from '../layouts/Layout.astro';
import RechnerCard from '../components/RechnerCard';
import { rechnerListe, kategorien } from '../data/rechner';

// Group by category
const gruppiertNachKategorie = Object.entries(kategorien).map(([key, kat]) => ({
  key,
  ...kat,
  rechner: rechnerListe.filter(r => r.kategorie === key),
}));
---

<Layout 
  title="Alle Rechner" 
  description="Deutschlandrechner: Kostenlose Online-Rechner fÃ¼r Deutschland 2025. Kindergeld, BÃ¼rgergeld, Brutto-Netto, Elterngeld, Grunderwerbsteuer und mehr."
  keywords="Deutschland Rechner, Online Rechner, Kindergeld Rechner, BÃ¼rgergeld Rechner, Brutto Netto Rechner, Elterngeld Rechner, Steuerrechner 2025, kostenlos"
>
  <main class="min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-12 px-4">
      <div class="max-w-7xl mx-auto text-center">
        <h1 class="text-4xl font-bold mb-3">ðŸ‡©ðŸ‡ª Deutschlandrechner</h1>
        <p class="text-blue-100 text-lg">Alle wichtigen Rechner fÃ¼r Deutschland â€“ kostenlos & aktuell</p>
      </div>
    </header>

    <!-- Search -->
    <div class="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b px-4 py-4">
      <div class="max-w-xl mx-auto">
        <input 
          type="search" 
          placeholder="ðŸ” Rechner suchen..." 
          class="w-full px-5 py-3 rounded-xl bg-gray-100 border-0 focus:ring-2 focus:ring-blue-500 outline-none text-lg"
          id="search-input"
        />
      </div>
    </div>

    <!-- Rechner Liste - 3 Spalten Grid -->
    <div class="max-w-7xl mx-auto px-4 py-8" id="rechner-liste">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {gruppiertNachKategorie.map(({ key, name, icon, color, rechner }) => (
          <section class="kategorie-section" data-kategorie={key}>
            <div class="flex items-center gap-2 mb-4">
              <span class={`w-10 h-10 rounded-xl ${color} flex items-center justify-center text-white text-lg`}>
                {icon}
              </span>
              <div>
                <h2 class="font-bold text-gray-800">{name}</h2>
                <span class="text-xs text-gray-400">{rechner.length} Rechner</span>
              </div>
            </div>
            <div class="space-y-3">
              {rechner.map((r) => (
                <div class="rechner-item" data-name={r.name.toLowerCase()}>
                  <RechnerCard rechner={r} client:load />
                </div>
              ))}
            </div>
          </section>
        ))}
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-8 text-gray-400 text-sm">
      <p>Â© 2025 Deutschlandrechner</p>
      <p class="mt-1">Alle Berechnungen ohne GewÃ¤hr</p>
    </footer>
  </main>
</Layout>

<script>
  // Search functionality - fixed version
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const rechnerItems = document.querySelectorAll('.rechner-item') as NodeListOf<HTMLElement>;
    const kategorienSections = document.querySelectorAll('.kategorie-section') as NodeListOf<HTMLElement>;

    if (!searchInput) return;

    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
      
      // Reset all if empty query
      if (!query) {
        rechnerItems.forEach(item => item.style.display = '');
        kategorienSections.forEach(section => section.style.display = '');
        return;
      }

      // Filter rechner items
      rechnerItems.forEach(item => {
        const name = item.getAttribute('data-name') || '';
        const matches = name.includes(query);
        item.style.display = matches ? '' : 'none';
      });

      // Hide empty categories
      kategorienSections.forEach(section => {
        const items = section.querySelectorAll('.rechner-item') as NodeListOf<HTMLElement>;
        const hasVisible = Array.from(items).some(item => item.style.display !== 'none');
        section.style.display = hasVisible ? '' : 'none';
      });
    });
  });
</script>
